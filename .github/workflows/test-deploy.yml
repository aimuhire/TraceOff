name: Test & Deploy

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

permissions:
  contents: read

concurrency:
  group: test-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # -------------------------
  # Server: test & build
  # -------------------------
  test-server:
    name: Test Server
    runs-on: ubuntu-latest
    timeout-minutes: 20
    env:
      CI: true
      ADMIN_SECRET: "aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa"
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
      - name: Install, lint, test, build
        working-directory: server
        run: |
          npm ci
          npm run lint
          npm test
          npm run build
      - name: Upload server build
        uses: actions/upload-artifact@v4
        with:
          name: server-build
          path: server/dist

  # -------------------------
  # Mobile: test Flutter web build
  # -------------------------
  test-mobile:
    name: Test Mobile (Flutter Web)
    runs-on: ubuntu-latest
    timeout-minutes: 20
    env:
      CI: true
    steps:
      - uses: actions/checkout@v4
      - uses: subosito/flutter-action@v2
        with:
          flutter-version: 3.35.3
          channel: stable
          cache: true
      - name: Ensure Flutter web is enabled
        working-directory: mobile
        run: flutter config --enable-web
      - name: Setup environment file
        run: cp mobile/.env.example mobile/.env
      - name: Test mobile app
        working-directory: mobile
        run: |
          flutter pub get
          flutter analyze
          flutter test
          flutter build web --release --no-wasm-dry-run
      - name: Upload web build
        uses: actions/upload-artifact@v4
        with:
          name: web-build
          path: mobile/build/web

  # -------------------------
  # Server: deploy (requires BOTH tests, only on main)
  # -------------------------
  deploy-server:
    name: Deploy Server (traceoffapi)
    runs-on: ubuntu-latest
    needs: [test-server, test-mobile]
    if: github.ref == 'refs/heads/main'
    env:
      VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
      VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_API_ID }}
      VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }} # optional for Personal
      VERCEL_TELEMETRY_DISABLED: "1"
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
      # Deploy from server directory
      - name: Vercel pull (production)
        working-directory: server
        run: npx vercel pull --yes --environment=production --token="$VERCEL_TOKEN"
      - name: Deploy to Vercel (prod)
        working-directory: server
        run: npx vercel deploy --prod --yes --token="$VERCEL_TOKEN"
      - name: Health check server
        run: |
          echo "Waiting for deployment to be ready..."
          sleep 30
          curl -f https://traceoffapi.vercel.app/api/health || exit 1
          echo "‚úÖ Server health check passed"

  # -------------------------
  # Web: deploy Flutter web (requires BOTH tests, only on main)
  # -------------------------
  deploy-web:
    name: Deploy Flutter Web (traceoff)
    runs-on: ubuntu-latest
    needs: [test-server, test-mobile]
    if: github.ref == 'refs/heads/main'
    env:
      VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
      VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_WEB_ID }}
      VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }} # optional
      VERCEL_TELEMETRY_DISABLED: "1"
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
      # Deploy using pre-built files from git
      - name: Verify web build files exist
        working-directory: mobile
        run: |
          if [ ! -d "build/web" ]; then
            echo "‚ùå Error: build/web directory not found. Make sure to commit Flutter web build files."
            exit 1
          fi
          echo "‚úÖ Web build files found"
          ls -la build/web/
      - name: Vercel pull (production)
        working-directory: mobile
        run: npx vercel pull --yes --environment=production --token="$VERCEL_TOKEN"
      - name: Deploy to Vercel (prod)
        working-directory: mobile
        run: npx vercel deploy --prod --yes --token="$VERCEL_TOKEN"
      - name: Health check mobile app
        run: |
          echo "Waiting for deployment to be ready..."
          sleep 30
          curl -f https://traceoff.vercel.app || exit 1
          echo "‚úÖ Mobile app health check passed"

  # -------------------------
  # Integration tests after deployment
  # -------------------------
  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: [deploy-server, deploy-web]
    if: github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4
      - name: Test API endpoints
        run: |
          echo "üß™ Testing API endpoints..."
          # Test health endpoint
          curl -f https://traceoffapi.vercel.app/api/health
          echo "‚úÖ Health endpoint working"
          
          # Test clean endpoint
          curl -f -X POST https://traceoffapi.vercel.app/api/clean \
            -H "Content-Type: application/json" \
            -d '{"url": "https://example.com?utm_source=test"}'
          echo "‚úÖ Clean endpoint working"
          
          # Test strategies endpoint
          curl -f https://traceoffapi.vercel.app/api/strategies
          echo "‚úÖ Strategies endpoint working"
      
      - name: Test mobile app
        run: |
          echo "üß™ Testing mobile app..."
          # Test mobile app loads
          curl -f https://traceoff.vercel.app
          echo "‚úÖ Mobile app loading"
          
          # Test mobile app assets
          curl -f https://traceoff.vercel.app/manifest.json
          echo "‚úÖ Mobile app assets working"
      
      - name: Deployment summary
        run: |
          echo "üéâ All deployments successful!"
          echo "üì± Mobile App: https://traceoff.vercel.app"
          echo "üîß API Server: https://traceoffapi.vercel.app"
          echo "üè• Health Check: https://traceoffapi.vercel.app/api/health"
